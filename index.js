import{addWord,removeWord,hasWord,secondsToHMS,SimpleDebouncer,parseFloatWithDefault,parseIntWithDefault}from"./lib/utils.js";import{SharePlaceGroup}from"./lib/ui_share_place.js";import{DOCK_TYPE,showPopup,hidePopup}from"./lib/ui_popup.js";import*as DefaultVideoCtrl from"./lib/h5_video_ctrl.js";import*as WPVideoCtrl from"./lib/wp_video_ctrl.js";var URL=window.URL||window.webkitURL;function _DefaultGetLangName(e){return e}function _GetLangFullName(e,t){t=t[e];if(t)return(e=t[new Intl.Locale(navigator.language).language])&&e instanceof Array?e[0]:t.en}var getLangName=_DefaultGetLangName;class PopupGroup{constructor(){this.dialogs=new Map}add(e,t,i){if(!t.id)throw new Error("elementDock missing Id!");this.dialogs.set(e.id,{did:t.id,dt:i,showed:!1})}remove(e){this.dialogs.delete(e.id)}showed(e){return this.dialogs.get(e.id).showed}show(e,t,i){this.hideAll();var s=this.dialogs.get(e.id),e=document.getElementById(e.id),n=document.getElementById(s.did);showPopup(e,n,s.dt,t,i),s.showed=!0}hide(e){var t=this.dialogs.get(e.id);hidePopup(e),t.showed=!1}hideAll(){for(var e of this.dialogs){var t=e[1],e=document.getElementById(e[0]);hidePopup(e),t.showed=!1}}toggle(e,t,i){this.showed(e)?this.hide(e):this.show(e,t,i)}}class Page{constructor(e,t){this._hiddenCSS=t,this.page=e,this.id=e.id,this.isActive=!hasWord(this.page.className,this._hiddenCSS)}active(){this.activeElement(this.page),this.isActive=!0}hide(){this.hideElement(this.page),this.isActive=!1}isActive(){return this.hidded}hideElement(e){hasWord(this._hiddenCSS,e.className)||(e.className=addWord(this._hiddenCSS,e.className))}activeElement(e){hasWord(this._hiddenCSS,e.className)&&(e.className=removeWord(this._hiddenCSS,e.className))}}let VIDEO_SOURCE_CHANGE_EVENT="video_source_change";class MainUI extends Page{constructor(){super(document.getElementById("page-main"),"hidden-display"),this.vcModule=WPVideoCtrl,this._hiddenCSS="hidden-display",this.initOpenFileControls(),this.initOpenURLControls()}initOpenFileControls(){this.btnOpenFile=document.getElementById("btn-open-file"),this.inputFileSelect=document.getElementById("input-video-file"),this.inputFileSelect.accept=this.vcModule.videoFilePattern(),this.btnOpenFile.addEventListener("click",()=>{this.hideElement(this.divInputURL),this.inputFileSelect.click()}),this.inputFileSelect.addEventListener("change",()=>{0<this.inputFileSelect.files.length&&(pageMgr.activePage("page-player"),this.triggerVideoFileSourceEvent())})}initOpenURLControls(){this.btnOpenURL=document.getElementById("btn-open-url"),this.divInputURL=document.getElementById("div-url"),this.btnURLInputSubmit=document.getElementById("btn-url-submit"),this.btnOpenURL.addEventListener("click",()=>{this.activeElement(this.divInputURL)})}triggerVideoFileSourceEvent(){var e=new CustomEvent(VIDEO_SOURCE_CHANGE_EVENT,{detail:{files:this.inputFileSelect.files}});console.log("trigger video file event"),document.dispatchEvent(e),this.inputFileSelect.value=""}}class NormalVideoView{constructor(e,t,i,s,n){this.videoContainer=e,this.video=t,this.vcPaddingWidth=i,this.vcBorderWidth=s,this.rangeSBSViewSize=n}update(e){var t=this.vcPaddingWidth.top+this.vcPaddingWidth.bottom+2*this.vcBorderWidth,i=this.vcPaddingWidth.left+this.vcPaddingWidth.right+2*this.vcBorderWidth,i=[e.width+i,e.height+t,i,t];window.innerHeight>=i[1]&&window.innerWidth>=i[0]?this._keepVideoSize(this.video,i,e.width,e.height):this._fitScreenSize(this.video,i,e.width,e.height)}_calcVideoSize(e,t){var i,s,n,o,a;return this.rangeSBSViewSize?(o=e*(n=(i=parseIntWithDefault(this.rangeSBSViewSize.value,1))/(s=parseInt(this.rangeSBSViewSize.max))),a=t*n,console.log("scale ",s,i,n),[o,a]):[e,t]}_keepVideoSize(e,t,i,s){var n=(window.innerHeight-t[1])/2+"px",o=(window.innerWidth-t[0])/2+"px";this.videoContainer.style.width=t[0]+"px",this.videoContainer.style.height=t[1]+"px",this.videoContainer.style.marginTop=n,this.videoContainer.style.marginBottom=n,this.videoContainer.style.marginLeft=o,this.videoContainer.style.marginRight=o,this._drawVideo(e,i,s)}_fitScreenSize(e,t){var i=Math.max(t[0]/window.innerWidth,t[1]/window.innerHeight),s=Math.floor(t[0]/i),i=Math.floor(t[1]/i),n=s-t[2],i=i-t[3],t=(window.innerWidth-s)/2+"px";this.videoContainer.style.width=n+"px",this.videoContainer.style.height=i+"px",this.videoContainer.style.marginTop="0px",this.videoContainer.style.marginBottom="0px",this.videoContainer.style.marginLeft=t,this.videoContainer.style.marginRight=t,this._drawVideo(e,n,i)}_drawVideo(e,t,i){t=this._calcVideoSize(t,i);e.style.width=t[0]+"px",e.style.height=t[1]+"px",e.style.paddingLeft="0px",e.style.paddingRight="0px"}}class SBSVideoView{constructor(e,t,i,s,n,o,a){this.videoContainer=e,this.videos=t,this.vcPaddingWidth=i,this.vcBorderWidth=s,this.rangeSBSViewSize=n,this.rangeSBSVPos=o,this.rangeSBSHPos=a}update(e){var t=this.vcPaddingWidth.top+this.vcPaddingWidth.bottom+2*this.vcBorderWidth,i=this.vcPaddingWidth.left+this.vcPaddingWidth.right+2*this.vcBorderWidth,i=[window.innerWidth-i,window.innerHeight-t,i,t],t=(window.innerHeight-i[1])/2+"px",s=(window.innerWidth-i[0])/2+"px",t=(this.videoContainer.style.width=i[0]+"px",this.videoContainer.style.height=i[1]+"px",this.videoContainer.style.marginTop=t,this.videoContainer.style.marginBottom=t,this.videoContainer.style.marginLeft=s,this.videoContainer.style.marginRight=s,[e.width,e.height]);i[1]>=e.height&&i[0]>=e.width*videos.length?this._keepVideoSize(this.videos,i,t):this._fitScreenSize(this.videos,i,t)}_calcVideoSize(e,t){var i,s,n,o,a;return this.rangeSBSViewSize?(o=e*(n=(i=parseIntWithDefault(this.rangeSBSViewSize.value,1))/(s=parseInt(this.rangeSBSViewSize.max))),a=t*n,console.log("scale ",s,i,n),[o,a]):[e,t]}_keepVideoSize(e,t,i){e=this._drawVideo(e,t,i);t[1]=e[1],this._drawVideoContainer(t)}_fitScreenSize(e,t,i){console.log("fit screen ",t,i);var s=i[0]*e.length,i=i[1],n=Math.min(t[0]/s,t[1]/i),s=Math.floor(s*n),i=Math.floor(i*n),n=Math.floor(s/e.length),s=i,i=(t[1]=s,this._drawVideo(e,t,[n,s]));t[1]=i[1],this._drawVideoContainer(t)}_drawVideoContainer(e){let t=0,i=0;var s,n,o,a,l;this.rangeSBSHPos&&this.rangeSBSVPos&&this.rangeSBSViewSize&&(s=parseInt(this.rangeSBSVPos.max),n=parseInt(this.rangeSBSVPos.min),o=parseIntWithDefault(this.rangeSBSVPos.value,0),a=window.innerHeight-e[1]-e[3],l=Math.floor(a/(s-n)),t=o*l,i=a-o*l,console.log("VERI ",n,s,o,l)),this.videoContainer.style.width=e[0]+"px",this.videoContainer.style.height=e[1]+"px",this.videoContainer.style.marginTop=t+"px",this.videoContainer.style.marginBottom=i+"px",this.videoContainer.style.marginLeft="0px",this.videoContainer.style.marginRight="0px"}_drawVideo(e,t,i){var s,n,o,i=this._calcVideoSize(i[0],i[1]);let a=0,l=0;return this.rangeSBSHPos&&this.rangeSBSVPos&&(s=parseInt(this.rangeSBSHPos.max),n=parseInt(this.rangeSBSHPos.min),o=parseIntWithDefault(this.rangeSBSHPos.value,0),t=Math.floor((t[0]-2*i[0])/(s-n)),a=t*o/2,l=t*o/2,console.log("HORI ",n,s,o,t)),e[0].style.width=i[0]+"px",e[0].style.height=i[1]+"px",e[0].style.paddingRight=a+"px",1<e.length&&(e[1].style.width=i[0]+"px",e[1].style.height=i[1]+"px",e[1].style.paddingLeft=l+"px"),i}}class PlayerUI extends Page{MODE_NORMAL="normal";MODE_SBS="sbs";SETTINGS_VER="0.0.2";SETTINGS_NAME="player_settings";VIDEO_CSS="video-fit-use-js";constructor(){super(document.getElementById("page-player"),"hidden-display"),this.vcModule=WPVideoCtrl,this.playControls=document.getElementById("div-play-controls"),this.controlsShowed=!1,this.resizeDebouncer=new SimpleDebouncer(this._onResize.bind(this),500),this.boundDebouncerCall=this.resizeDebouncer.call.bind(this.resizeDebouncer),this.popupGroup=new PopupGroup,this.initSavedSettings(),this.initVideo(),this.initFullscreenButtons(),this.initViewModeButtons(),this.initVolumeButtons(),this.initPlayButtons(),this.initStreamSelectorButton(),this.initProgressCtrls(),this.initBackButton()}active(){super.active(),this.videoView.update(this.videoCtrl),this.hideControls(),window.addEventListener("resize",this.boundDebouncerCall)}hide(){window.removeEventListener("resize",this.boundDebouncerCall),super.hide(),document.fullscreenElement&&(document.exitFullscreen(),screen.orientation.unlock()),this.hideControls(),this.videoCtrl.ended||this.videoCtrl.pause()}initSavedSettings(){var e=localStorage.getItem("settings");let t=null;(t=e?JSON.parse(e):t)&&t.type!=this.SETTINGS_NAME&&(console.log("invalid settings item be found, reset it!",t),t=null),t&&t.ver==this.SETTINGS_VER?(console.log("Valid settings item be found, use it!",t),this._savedSettings=t):(this._savedSettings={ver:this.SETTINGS_VER,type:this.SETTINGS_NAME},this._savedSettings.view={rangeSize:{max:"20",min:"10",val:"20"},rangeHPos:{max:"10",min:"0",val:"0"},rangeVPos:{max:"10",min:"0",val:"5"}}),this._oldSettingsStr=e,this._savedSettingsTimer=setTimeout(()=>{var e=JSON.stringify(this._savedSettings);this._oldSettingsStr!=e&&(console.log("settings changed, save it"),localStorage.setItem("settings",e),this._oldSettingsStr=e)},6e4)}showControls(){this.activeElement(this.btnBack),this.activeElement(this.playControls),this.controlsShowed=!0}hideControls(){this.popupGroup.hideAll(),this.hideElement(this.btnBack),this.hideElement(this.playControls),this.controlsShowed=!1}initFullscreenButtons(){this.btnFullscreen=document.getElementById("btn-fullscreen"),this.btnFullscreenExit=document.getElementById("btn-fullscreen-exit"),this.spFullscreen=new SharePlaceGroup([this.btnFullscreen,this.btnFullscreenExit],"hidden-display"),this.spFullscreen.disableAll(),this.spFullscreen.updateTo(this.btnFullscreen),this.btnFullscreen.addEventListener("click",()=>{this.enterFullscreen()}),this.btnFullscreenExit.addEventListener("click",()=>{this.exitFullscreen()})}enterFullscreen(){document.documentElement.requestFullscreen().then(()=>{screen.orientation.lock("landscape"),this.spFullscreen.updateTo(this.btnFullscreenExit),console.log("window: ",window.innerWidth,window.innerHeight),console.log("screen: ",window.screen.width,window.screen.height),console.log("devicePR:",window.devicePixelRatio)}).catch(e=>{this.spFullscreen.updateTo(this.btnFullscreen),console.log("requestFullscreen failed: ",e),console.log("window: ",window.innerWidth,window.innerHeight),console.log("screen: ",window.screen.width,window.screen.height),console.log("devicePR:",window.devicePixelRatio)})}exitFullscreen(){document.exitFullscreen().then(()=>{this.spFullscreen.updateTo(this.btnFullscreen)}).catch(e=>{console.log("exitFullscreen failed: ",e)})}initViewModeButtons(){this.btnVRMode=document.getElementById("btn-vr-mode"),this.btnNormalMode=document.getElementById("btn-normal-mode"),this.btnSettings=document.getElementById("btn-settings"),this.popupSettings=document.getElementById("div-popup-settings"),this.rangeSBSViewSize=document.getElementById("range-SBSViewSize"),this.rangeSBSHPos=document.getElementById("range-SBSHPos"),this.rangeSBSVPos=document.getElementById("range-SBSVPos"),this.divSBSOnlySettings=document.getElementById("div-sbsonly-settings"),this.spViewMode=new SharePlaceGroup([this.btnVRMode,this.btnNormalMode],"hidden-display");let e=this._savedSettings.view;e&&(this.rangeSBSViewSize.max=e.rangeSize.max,this.rangeSBSViewSize.min=e.rangeSize.min,this.rangeSBSViewSize.value=e.rangeSize.value,this.rangeSBSHPos.max=e.rangeHPos.max,this.rangeSBSHPos.min=e.rangeHPos.min,this.rangeSBSHPos.value=e.rangeHPos.value,this.rangeSBSVPos.max=e.rangeVPos.max,this.rangeSBSVPos.min=e.rangeVPos.min,this.rangeSBSVPos.value=e.rangeVPos.value),this.showNormalVideo(),this.spViewMode.disableAll(),this.spViewMode.updateTo(this.btnVRMode),this.btnVRMode.addEventListener("click",()=>{this.spViewMode.updateTo(this.btnNormalMode),this.switchMode(this.MODE_SBS)}),this.btnNormalMode.addEventListener("click",()=>{this.spViewMode.updateTo(this.btnVRMode),this.switchMode(this.MODE_NORMAL)}),this.popupGroup.add(this.popupSettings,this.playControls,DOCK_TYPE.BOTTOM_TOP),this.btnSettings.addEventListener("click",e=>{var t=this.btnSettings.getBoundingClientRect().x-this.popupSettings.getBoundingClientRect().width/2;this.popupGroup.toggle(this.popupSettings,t,-5)}),this.rangeSBSViewSize.addEventListener("change",()=>{this.videoView.update(this.videoCtrl),e.rangeSize.value=this.rangeSBSViewSize.value,this._safeSetScale()}),this.rangeSBSHPos.addEventListener("change",()=>{this.videoView.update(this.videoCtrl),e.rangeHPos.value=this.rangeSBSHPos.value}),this.rangeSBSVPos.addEventListener("change",()=>{this.videoView.update(this.videoCtrl),e.rangeVPos.value=this.rangeSBSVPos.value})}initVolumeButtons(){this.btnMute=document.getElementById("btn-mute"),this.btnVolumeOpen=document.getElementById("btn-volume-open"),this.rangeVolume=document.getElementById("range-volume"),this.spVolume=new SharePlaceGroup([this.btnMute,this.btnVolumeOpen],"hidden-display"),this.spVolume.disableAll(),this.spVolume.updateTo(this.btnMute),this.rangeVolume.value=100*this.videoCtrl.volume,this.btnMute.addEventListener("click",()=>{this.spVolume.updateTo(this.btnVolumeOpen),this.rangeVolume.disabled="disabled",this.videoCtrl.muted=!0}),this.btnVolumeOpen.addEventListener("click",()=>{this.spVolume.updateTo(this.btnMute),this.rangeVolume.disabled="",this.videoCtrl.muted=!1}),this.rangeVolume.addEventListener("change",e=>{console.log("volume change to "+e.target.value),this.videoCtrl.volume=e.target.value/100})}initPlayButtons(){this.btnPlay=document.getElementById("btn-play"),this.btnPause=document.getElementById("btn-pause"),this.spPlay=new SharePlaceGroup([this.btnPlay,this.btnPause],"hidden-display"),this.userPlayed=!1,this.userPaused=!1,this.spPlay.disableAll(),this.spPlay.updateTo(this.btnPlay),this.btnPlay.addEventListener("click",()=>{this.spPlay.updateTo(this.btnPause),this.videoCtrl.play(),this.userPlayed=!0}),this.btnPause.addEventListener("click",()=>{this.spPlay.updateTo(this.btnPlay),this.videoCtrl.pause(),this.userPaused=!0}),this.btnPlayRate=document.getElementById("btn-playrate"),this.popupPlayrate=document.getElementById("div-popup-playrate"),this.radioPlayRates=document.getElementsByName("radio-playrate"),this.popupGroup.add(this.popupPlayrate,this.playControls,DOCK_TYPE.BOTTOM_TOP),this.btnPlayRate.addEventListener("click",()=>{var e,t=this.btnPlayRate.getBoundingClientRect().x;for(e of this.radioPlayRates)e.value==this.btnPlayRate.innerText&&(e.checked=!0);this.popupGroup.toggle(this.popupPlayrate,t,-1)}),this.radioPlayRates.forEach(e=>{e.addEventListener("click",e=>{this.btnPlayRate.innerText=e.target.value,this.popupGroup.hide(this.popupPlayrate),console.log("video playrate is ",this.videoCtrl.playbackRate);e=Number.parseFloat(e.target.value.substr(0,e.target.value.length));console.log("playrate changeto "+e),this.videoCtrl.playbackRate=e})}),this.videoCtrl.addEventListener("play",()=>{this.spPlay.currentElement!=this.btnPause&&this.spPlay.updateTo(this.btnPause)}),this.videoCtrl.addEventListener("pause",()=>{this.spPlay.currentElement!=this.btnPlay&&this.spPlay.updateTo(this.btnPlay)})}initStreamSelectorButton(){this.inputVTTFileSelect=document.getElementById("input-subtitle-file"),this.btnSS=document.getElementById("btn-streamselector"),this.inputVTTFileSelect.accept=this.vcModule.subtitleFilePattern(),this.streams?this.initStreamSelectors():this.btnSS.disabled="disabled"}_addStreamRadio(e,t,i,s){var i=i.cloneNode(!0),n=(i.removeAttribute("id"),i.getElementsByTagName("input")[0]),o=i.getElementsByTagName("label")[0];n.value=e.id,n.id=n.id+e.id,o.htmlFor=n.id,s&&(n.checked=!0);let a="";e.language&&e.title?a=getLangName(e.language)+"<br />"+e.title:e.language?a=getLangName(e.language):e.title&&(a=e.title),o.innerHTML=a,t.appendChild(i)}_addExternSubtitleFile(e){var t,i={},s=(i.title=e[0].name,i.id=WPVideoCtrl.STREAM_TYPE_EXTERNAL_SUBTITLE,this.subtitleSelector.getElementsByTagName("input")),n=""+i.id;let o;for(t of s)n==t.value&&(o=t);o?o.nextElementSibling().setAttribute("innerText",i.title):this._addStreamRadio(i,this.subtitleSelector,this.subtitleItemTpl,!1),this.externalSubtitleFiles=e,this.videoCtrl.setExternalSubtitleFiles(e)}_getSelectedStream(e){var t;for(t of e.getElementsByTagName("input"))if(t.checked)return t.value}_getAllSelectedStreams(){var e={};return e.subtitle=this._getSelectedStream(this.subtitleSelector),e.audio=this._getSelectedStream(this.audioSelector),e}initStreamSelectors(){this.btnSS.disabled="",this._ssInited||(this.popupStreams=document.getElementById("div-popup-streams"),this.audioSelector=document.getElementById("div-audio-selector"),this.subtitleSelector=document.getElementById("div-subtitle-selector"),this.audioItemTpl=document.getElementById("div-audio-selector-item-template"),this.subtitleItemTpl=document.getElementById("div-subtitle-selector-item-template"),this.btnOpenSubtitleFile=document.getElementById("btn-open-subtitlefile"),this.btnSSApply=document.getElementById("btn-streamselect-apply"),this.popupGroup.add(this.popupStreams,this.playControls,DOCK_TYPE.BOTTOM_TOP),this.btnSS.addEventListener("click",()=>{console.log("pwa: popup streams selector");var e=this.playControls.getBoundingClientRect(),t=this.popupStreams.getBoundingClientRect(),e=e.x+e.width-t.width;this.popupGroup.toggle(this.popupStreams,e,-1)}),this.btnOpenSubtitleFile.addEventListener("click",()=>{this.inputVTTFileSelect.click()}),this.inputVTTFileSelect.addEventListener("change",()=>{console.log("setVTT ",this.inputVTTFileSelect.files),0<this.inputVTTFileSelect.files.length&&this._addExternSubtitleFile(this.inputVTTFileSelect.files),this.inputVTTFileSelect.value=""}),this.btnSSApply.addEventListener("click",()=>{var e=this._getAllSelectedStreams();console.log("pwa: selected streams ",e),this.videoCtrl.changeStreams(parseInt(e.audio),parseInt(e.subtitle)),this.popupGroup.hide(this.popupStreams)}),this._ssInited=!0),this.audioSelector.replaceChildren(),this.subtitleSelector.replaceChildren(),this.subtitleSelector.appendChild(this.btnOpenSubtitleFile);var e,t,i,s=[],n=[],o=this.streams[0];for(e in o){var a=o[e];a.type==WPVideoCtrl.STREAM_TYPE_AUDIO?s.push(a):a.type==WPVideoCtrl.STREAM_TYPE_SUBTITLE&&n.push(a)}for(t of s){console.log("pwa: add audio stream info "+t.id);var l=t.id==this.playInfos.audioStreamID;this._addStreamRadio(t,this.audioSelector,this.audioItemTpl,l)}for(i of n){console.log("pwa: add subtitle stream info "+i.id);var r=i.id==this.playInfos.subtitleStreamID;this._addStreamRadio(i,this.subtitleSelector,this.subtitleItemTpl,r)}0<this.inputVTTFileSelect.files.length&&this._addExternSubtitleFile(this.inputVTTFileSelect.files)}initProgressCtrls(){this.rangeProgress=document.getElementById("range-progress"),this.popupPlayTime=document.getElementById("div-popup-playtime"),this.textTimeElapsed=document.getElementById("text-time-elapsed"),this.textTimeTotal=document.getElementById("text-time-total"),this._dragging=!1,this._progressDragged=!1,this.rangeProgress.addEventListener("pointerdown",e=>{this._progressDragged=!0,this.videoCtrl.pause()}),this.rangeProgress.addEventListener("pointerup",e=>{this._progressDragged=!1,this.videoCtrl.play()}),this._onProgressInput=e=>{console.log("progress changed ",e,this.rangeProgress.value);e=parseInt(this.rangeProgress.value);this.videoCtrl.seekTo(e)},this._progressDebouncer=new SimpleDebouncer(this._onProgressInput,70),this.boundProgressCall=this._progressDebouncer.call.bind(this._progressDebouncer),this.rangeProgress.addEventListener("input",this.boundProgressCall)}updateProgress(){var e=Math.ceil(this.videoCtrl.currentTime),t=Math.ceil(this.videoCtrl.duration),i=secondsToHMS(e),s=secondsToHMS(t);this.textTimeElapsed.innerHTML=i,this.textTimeTotal.innerHTML=s,this.rangeProgress.max=""+t,this.rangeProgress.value=""+e}beginUpdateProgress(){if(!this._updateProgressTimer){let e=this;e.updateProgress(),this._updateProgressTimer=setInterval(function(){e.updateProgress()},1e3)}}stopUpdateProgress(){this._updateProgressTimer&&(clearTimeout(this._updateProgressTimer),this._updateProgressTimer=null)}calculateProgressByPoint(e){var t=Math.ceil(this.videoCtrl.duration),i=this.rangeProgress.clientWidth,s=this.rangeProgress.getBoundingClientRect();let n=e.pageX-s.left;return n<0&&(n=0),Math.round(t*(n/i))}initBackButton(){this.btnBack=document.getElementById("div-back-main"),this.btnBack.addEventListener("click",()=>{pageMgr.activePage("page-main")})}initVideoRatio(){this.videoRatioUser=null,this.videoClass=null,this.videoCtrl.addEventListener(this.vcModule.VIDEOCTRL_ASPECT_RATIO_EVENT,e=>{e=e.detail.ctrl;console.log("videoctrl ratio:",e.width,e.height,e.ratio),console.log("window: ",window.innerWidth,window.innerHeight),console.log("screen: ",window.screen.width,window.screen.height),console.log("devicePR:",window.devicePixelRatio),this.videoView.update(this.videoCtrl)})}initVideoContainer(){this.videoContainer=document.getElementById("div-video");var e=getComputedStyle(this.videoContainer);this._vcBorderWidth=parseFloatWithDefault(e.border),isNaN(this._vcBorderWidth)&&(this._vcBorderWidth=0),this._vcPaddingWidth={left:parseFloatWithDefault(e.paddingLeft),right:parseFloatWithDefault(e.paddingRight),top:parseFloatWithDefault(e.paddingTop),bottom:parseFloatWithDefault(e.paddingBottom)},console.log("videoContainer rect",this._vcBorderWidth,this._vcPaddingWidth)}initVideo(){this.initVideoContainer(),this.videoCtrl=this.vcModule.createNormalVideo(null,this.videoContainer,this.VIDEO_CSS),document.addEventListener(VIDEO_SOURCE_CHANGE_EVENT,e=>{console.log("receive video src event! ",e),e.detail.files&&(e=e.detail.files[0],console.log("src ",e),e instanceof File?(console.log("video src ",e.name,e.size),this.videoCtrl.playLocalFile(e)):this.videoCtrl.playSource(e))}),this.videoContainer.addEventListener("click",()=>{console.log("page clicked"),this.controlsShowed?this.hideControls():this.showControls()}),this.videoCtrl.addEventListener("play",e=>{console.log("pwa: begin play"),console.log("pwa: streams ",JSON.stringify(e.detail.streams)),console.log("pwa: info ",e.detail.info),this.streams=e.detail.streams,this.playInfos=e.detail.info,this.voiceStream=this.playInfos.audioStreamID,this.subtitleStream=this.playInfos.subtitleStreamID,this.streams?this.initStreamSelectors():this.btnSS.disabled="disabled",this.beginUpdateProgress(),this._safeSetScale()}),this.videoCtrl.addEventListener("pause",()=>{console.log("pause play"),this.stopUpdateProgress()}),this.videoCtrl.addEventListener("end",()=>{console.log("end play"),this.stopUpdateProgress()}),this.initVideoRatio()}switchMode(e){console.log("swithMode to",e),e==this.MODE_NORMAL?(this.videoCtrl=this.vcModule.createNormalVideo(this.videoCtrl,this.videoContainer,this.VIDEO_CSS),this.showNormalVideo()):e==this.MODE_SBS&&(this.videoCtrl=this.vcModule.createSBSVideo(this.videoCtrl,this.videoContainer,this.VIDEO_CSS),this.showSBSVideo())}_calcVideoScale(){var e=parseInt(this.rangeSBSViewSize.max),t=parseInt(this.rangeSBSViewSize.min),e=e-t;return(parseInt(this.rangeSBSViewSize.value)-t)/e}showSBSVideo(){hasWord("sbs",this.videoContainer.className)||(this.videoContainer.className=addWord("sbs",this.videoContainer.className));var e=this.videoContainer.getElementsByClassName(this.VIDEO_CSS);this.videoView=new SBSVideoView(this.videoContainer,e,this._vcPaddingWidth,this._vcBorderWidth,"function"==typeof this.videoCtrl.setScale?null:this.rangeSBSViewSize,"function"==typeof this.videoCtrl.setVPos?null:this.rangeSBSVPos,"function"==typeof this.videoCtrl.setHPos?null:this.rangeSBSHPos),this._safeSetScale(),this.divSBSOnlySettings.className=removeWord("hidden-display",this.divSBSOnlySettings.className)}_safeSetScale(){"function"==typeof this.videoCtrl.setScale&&this.videoCtrl.setScale(this._calcVideoScale())}showNormalVideo(){hasWord("sbs",this.videoContainer.className)&&(this.videoContainer.className=removeWord("sbs",this.videoContainer.className));var e=this.videoContainer.getElementsByClassName(this.VIDEO_CSS)[0];this.videoView=new NormalVideoView(this.videoContainer,e,this._vcPaddingWidth,this._vcBorderWidth,"function"==typeof this.videoCtrl.setScale?null:this.rangeSBSViewSize),this._safeSetScale(),this.divSBSOnlySettings.className=addWord("hidden-display",this.divSBSOnlySettings.className)}_onResize(){this.videoCtrl.ratio&&this.videoView.update(this.videoCtrl)}}class PageManager{constructor(e,t){this._defaultPage=t,this._pages=new Map(e.map(e=>(e.hide(),[e.id,e]))),console.log("pages count ",this._pages.size),this.currentPage=null,this.activePage()}activePage(e){let t=null;t=e?this._pages.get(e):this._defaultPage,this.currentPage&&this.currentPage.hide(),this.currentPage=t,console.log("active page ",t.id),this.currentPage.active()}}var pageMgr=null;function conformUpdateNow(e){confirm("Has a new version, do u want update immediatly?")&&e.installing.postMessage(JSON.stringify({type:"SKIP_WAITING"}))}function registerServiceWorker(){if("serviceWorker"in navigator){navigator.serviceWorker.register("./service-worker.js",{scope:"./"}).then(t=>{console.log("Service worker registered --\x3e",t),t.installing&&(t.installing.onerror=e=>{console.log("Service worker installing error:",e)},t.installing.onstatechange=e=>{console.log("Service worker state changed:",e)},conformUpdateNow(t)),t.onupdatefound=e=>{console.log("Service worker has a new version:",e),conformUpdateNow(t)}},e=>{console.error("Service worker not registered --\x3e",e)}),navigator.serviceWorker.onmessage=e=>{e=JSON.parse(e.data);console.log("received message from sw:",e)};let t=!(navigator.serviceWorker.onerror=e=>{console.log("Service worker occured error:",e)});navigator.serviceWorker.oncontrollerchange=e=>{console.log("Service worker changed:",e),t||(t=!0,window.location.reload())},navigator.serviceWorker.onmessageerror=e=>{console.log("Service worker sent message error:",e)},console.log("serviceWorker is ",navigator.serviceWorker)}else console.log("browser doesn't support serviceworker!")}function initialize(){registerServiceWorker();var e=new PlayerUI,t=new MainUI;pageMgr=new PageManager([e,t],t)}document.addEventListener("DOMContentLoaded",async e=>{console.log("DOM loaded!");let t;try{var i=await fetch("/iso_639-2.min.json");t=await i.json()}catch(e){throw console.log("loaded iso_639-2.min.json failed:",e.stack),e}getLangName=e=>_GetLangFullName(e,t),initialize()});