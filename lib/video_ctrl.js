var URL=window.URL||window.webkitURL,VIDEOCTRL_ASPECT_RATIO_EVENT="videoctrl-aspect-ratio";class VideoCtrlBase{constructor(e){this._video=e,this.width=0,this.height=0,this.ratio=null,this._userPlayed=!1,this._userPaused=!1;var t=this;this._on_loadedmetadata=()=>{t.width=t._video.videoWidth,t.height=t._video.videoHeight,t.ratio=t.height/t.width;var e=new CustomEvent(VIDEOCTRL_ASPECT_RATIO_EVENT,{detail:{ctrl:t}});t._video.dispatchEvent(e)},this._video.addEventListener("loadedmetadata",this._on_loadedmetadata,{})}_getVTTElement(e){for(var t=e.getElementsByTagName("track"),i=0;i<t.length;i++)if("subtitles"==t[i].kind)return t[i];return null}_createVTTElement(t,e){var i=document.createElement("track");i.kind="subtitles",i.label="English",i.srclang="en",i.src=e,t.appendChild(i);let s=t.textTracks[t.textTracks.length-1];i.addEventListener("load",function(){this.mode="showing",s.mode="showing"}),console.log("now video tracks length is "+t.textTracks.length);for(let e=0;e<t.textTracks.length;++e)t.textTracks[e].mode="hidden"}_removeAllTracks(e){for(var t of e.getElementsByTagName("track"))e.removeChild(t)}free(){this._video.removeEventListener("loadedmetadata",this._on_loadedmetadata,{}),this._video=null}get video(){return this._video}get paused(){return this._video.paused}get ended(){return this._video.ended}get played(){return this._video.played}get currentTime(){return this._video.currentTime}get duration(){return this._video.duration}get src(){return this._video.src}get muted(){return this._video.muted}get volume(){return this._video.volume}get playbackRate(){return this._video.playbackRate}get userPlayed(){return this._userPlayed}setUserPlayed(){this._userPlayed=!0,this._userPaused=!1}get userPaused(){return this._userPaused}setUserPaused(){this._userPlayed=!1,this._userPaused=!0}addEventListener(e,t,i){this._video.addEventListener(e,t,i)}canPlay(e){e=e.type;return""!==this._video.canPlayType(e)}}class PWAVideoCtrl extends VideoCtrlBase{constructor(e){super(e)}set muted(e){this._video.muted=e}set volume(e){this._video.volume=e}set playbackRate(e){this._video.playbackRate=e}playLocalFile(e){e=URL.createObjectURL(e);return this._video.src=e,this._video.play(),this.setUserPlayed(),!0}playSource(e,t){return this._video.src=e,this._video.currentTime=t,this._video.play(),this.setUserPlayed(),!0}pause(){this._video.pause(),this.setUserPaused()}play(){this._video.play(),this.setUserPlayed()}restart(){this._video.currentTime=0,this.setUserPlayed()}seekTo(e){this._video.currentTime=e}setVTT(e){e=(window.URL||window.webkitURL).createObjectURL(e);console.log("set vtt "+e),this._createVTTElement(this._video,e)}clearVTT(){for(var e of this._video.textTracks)e.mode="disabled";this._removeAllTracks(this._video)}}class PWASBSVideoCtrl extends VideoCtrlBase{MISSED_INTERVAL=7.8;constructor(e,t){super(e),this._videoRight=t,this._mediaTimeLeft=null,this._mediaTimeRight=null,this._userPlayed=!1,this._userPaused=!1;let i=this;this._video.autoplay=!1,this._videoRight.autoplay=!1,this._video.preload="auto",this._videoRight.preload="auto",this._on_loadeddata=()=>{i._playThrough()},this._on_ended=()=>{i._clearFrameCheckTimer()},this._video.addEventListener("ended",this._on_ended),this._playBegan=!1,this._video.addEventListener("loadeddata",this._on_loadeddata),this._videoRight.addEventListener("loadeddata",this._on_loadeddata)}_playThrough(){4<=this._video.readyState&&4<=this._videoRight.readyState&&!this._playBegan&&(console.log("begin play"),this._video.play(),this._videoRight.play(),this._playBegan=!0)}_startFrameCheckTimer(){var e;this._frameCheckTimer||(this._frameCheckTimer=!0,(e=()=>{this._frameCheckTimer&&requestAnimationFrame(()=>{this.onRequestAnimate(),e()})})())}_clearFrameCheckTimer(){this._frameCheckTimer&&(this._frameCheckTimer=null,console.log("SBS play stats:",JSON.stringify(this.stats)))}free(){this._clearFrameCheckTimer(),this._video.removeEventListener("loadeddata",this._on_loadeddata),this._video.removeEventListener("ended",this._on_ended),this._videoRight.removeEventListener("loadeddata",this._on_loadeddata),this._video=null,this._videoRight=null,console.log("free PWASBSVideoCtrl")}clearVTT(){for(var e of this._video.textTracks)e.mode="disabled";this._removeAllTracks(this._video);for(var t of this._videoRight.textTracks)t.mode="disabled";this._removeAllTracks(this._videoRight)}set muted(e){this._video.muted=e,this._videoRight.muted=e}set volume(e){this._video.volume=e,this._videoRight.volume=e}set playbackRate(e){this._video.playbackRate=e,this._videoRight.playbackRate=e}playLocalFile(e){e=(window.URL||window.webkitURL).createObjectURL(e);return this._video.src=e,this._videoRight.src=e,this.stats={missed:0},this._startFrameCheckTimer(),this.setUserPlayed(),!0}playSource(e,t){return this._video.src=e,this._videoRight.src=this._video.src,t&&(this._video.currentTime=t,this._videoRight.currentTime=t),this.stats={missed:0},this._startFrameCheckTimer(),this.setUserPlayed(),!0}pause(){this._video.pause(),this._videoRight.pause(),this._clearFrameCheckTimer(),this.setUserPaused()}play(){this._video.play(),this._videoRight.play(),this._startFrameCheckTimer(),this.setUserPlayed()}restart(){this._video.currentTime=0,this._videoRight.currentTime=0,this.stats={missed:0},this._startFrameCheckTimer(),this.setUserPlayed()}seekTo(e){this._video.currentTime=e,this._videoRight.currentTime=e}setVTT(e){e=(window.URL||window.webkitURL).createObjectURL(e);console.log("set vtt "+e),this._createVTTElement(this._video,e),this._createVTTElement(this._videoRight,e)}removeAllTracks(){}onRequestAnimate(){var e,t;this._userPlayed&&(e=Math.round(1e3*this._video.currentTime),t=Math.round(1e3*this._videoRight.currentTime),Math.abs(e-t)>this.MISSED_INTERVAL)&&console.log("play time miss match",e,t)}}export{PWAVideoCtrl,PWASBSVideoCtrl,VIDEOCTRL_ASPECT_RATIO_EVENT};