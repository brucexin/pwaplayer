import{secondsToHMS}from"./lib/utils.js";import{DOCK_TYPE,showPopup,hidePopup}from"./lib/ui_popup.js";import{default as backend}from"./player_backend.js";let _BE=null;function handleVideoSourceMetaData(e){console.log("handleVideoSourceMetaData",e),document.title=e.title,document.getElementById("label-playtime").innerText=secondsToHMS(e.duration),document.getElementById("input-playtime").max=e.duration}function handleVideoSizeChanged(e){var t=e.width,e=e.height,n=document.getElementById("main"),d=n.getClientRects()[0];let l=t,a=e;(t>window.innerWidth-2*d.left||e>window.innerHeight)&&(d=Math.max(t/(window.innerWidth-2*d.left),e/window.innerHeight),l=Math.floor(t/d),a=Math.floor(e/d)),n.style.width=l+"px",n.style.height=a+"px",_BE.handleCanvasResize()}function addExternalSubtitleStream(e){var t,n=document.getElementById("subtitle-input");n.files.length&&((t=document.createElement("option")).text="1000 "+n.files[0].name,t.value=1e3,(n=document.getElementById("option-subtitle-stream-1000"))?e.replaceChild(t,n):e.add(t))}function handleVideoBegin(e){var t,n=_BE.getStreams(),d=(console.log("video begin play, streams info:",n),console.log("video begin play, play info:",e),document.getElementById("textarea-metadata")),l=JSON.stringify(n,null,2),a=(d.innerText=l,document.getElementById("subtitle-select")),o=document.getElementById("audio-select");for(t in a.replaceChildren(),o.replaceChildren(),n[0]){var i,m=n[0][t];2!=m.type&&3!=m.type||((i=document.createElement("option")).text=m.id+" "+m.language,i.value=m.id,(2==m.type?(e.audioStreamID==t&&(i.defaultSelected=!0),i.id="option-audio-stream-"+m.id,o):(e.subtitleStreamID==t&&(i.defaultSelected=!0),i.id="option-subtitle-stream-"+m.id,a)).add(i))}addExternalSubtitleStream(a)}function handleVideoEnd(){document.getElementById("btn-pause").disabled=!0,document.getElementById("btn-play").disabled=!1,document.getElementById("btn-end").disabled=!0}function handleRenderEnd(e){document.getElementById("span_frames_count").innerHTML=""+e.framesCount,document.getElementById("h2_fps").innerHTML=""+e.fps;document.getElementById("h2_pts").innerHTML=""+e.timer;var e=document.getElementById("div_pts"),t=document.getElementById("main");showPopup(e,t,DOCK_TYPE.TOP_TOP,0,0)}function init(){var e=document.getElementById("main");_BE=new backend(e),e.addEventListener("resize",e=>{}),document.getElementById("file-input").addEventListener("change",e=>{e=e.currentTarget.files[0];console.log("select file "+e.name),_BE.setSource(e)}),document.getElementById("subtitle-input").addEventListener("change",e=>{console.log("select subtitle files ",e.currentTarget.files.length),_BE.setExternalSubtitleFiles(e.currentTarget.files),addExternalSubtitleStream(document.getElementById("subtitle-select"))}),document.getElementById("btn-play").addEventListener("click",e=>{_BE.onPlay(),document.getElementById("btn-pause").disabled=!1,document.getElementById("btn-play").disabled=!0,document.getElementById("btn-end").disabled=!1}),document.getElementById("btn-pause").addEventListener("click",e=>{_BE.onPause(),document.getElementById("btn-pause").disabled=!0,document.getElementById("btn-play").disabled=!1}),document.getElementById("btn-end").addEventListener("click",e=>{_BE.onEnd(),document.getElementById("btn-pause").disabled=!0,document.getElementById("btn-play").disabled=!1,document.getElementById("btn-end").disabled=!0}),document.getElementById("bg-input").addEventListener("change",e=>{e=e.currentTarget.files[0];console.log("select bg file "+e.name),bgUrl&&URL.revokeObjectURL(bgUrl),bgUrl=URL.createObjectURL(e),document.getElementById("main").style=`background: no-repeat center url("${bgUrl}")`}),document.getElementById("input-playtime").addEventListener("change",e=>{console.log("seeker change: this is ",this,e.target.id);e=parseFloat(e.target.value);_BE.onSeek(e),document.getElementById("label-playtime").innerText=secondsToHMS(e)});const t=document.getElementById("sbsmode-input");t.addEventListener("change",e=>{t.checked?_BE.setSBSMode({scaleLevel:.8}):_BE.setNormalMode(1)}),document.getElementById("input-volume").addEventListener("change",e=>{e=parseFloat(e.target.value);_BE.setVolume(e/10)}),document.getElementById("btn-streamselect-apply").addEventListener("click",()=>{var e=document.getElementById("subtitle-select"),t=document.getElementById("audio-select"),e=e.selectedOptions[0],t=t.selectedOptions[0],e=e?e.value:null;console.log(`subtitle selected ${e} audio selected `+t.value),_BE.onChangeStreams(parseInt(t.value),parseInt(e))}),_BE.onVideoSizeChanged=handleVideoSizeChanged,_BE.onVideoSourceMetaData=handleVideoSourceMetaData,_BE.onVideoBegin=handleVideoBegin,_BE.onVideoEnd=handleVideoEnd,_BE.onRenderEnd=handleRenderEnd}document.addEventListener("DOMContentLoaded",e=>{console.log("DOM loaded!"),init()});